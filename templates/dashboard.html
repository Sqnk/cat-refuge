{% extends "base.html" %}
{% block content %}
<h1 class="mb-3">Dashboard</h1>

<div class="row">
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header">Statistiques</div>
      <div class="card-body">
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between"><span>Chats</span><strong>{{ stats.cats }}</strong></li>
          <li class="list-group-item d-flex justify-content-between"><span>Rendez-vous</span><strong>{{ stats.appointments }}</strong></li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Vaccins √† traiter</span>
            <strong>{{ stats.vaccines_due }}</strong>
          </li>
        </ul>
      </div>
    </div>

    <div class="card mb-3 border-danger">
      <div class="card-header text-danger fw-bold">Vaccins en retard</div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush">
          {% for v in alerts.overdue %}
          <li class="list-group-item">
            <a href="{{ url_for('view_cat', cat_id=v.cat.id) }}">{{ v.cat.name }}</a>
            ‚Äî <strong>{{ v.vaccine }}</strong>
            <div class="small text-muted">
              {% if v.never %}Jamais vaccin√©{% else %}Dernier: {{ v.last_date.strftime('%d/%m/%Y') }}, rappel d√ª: {{ v.next_due.strftime('%d/%m/%Y') }}{% endif %}
            </div>
          </li>
          {% else %}
          <li class="list-group-item">Aucun vaccin en retard.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Vaccins √† pr√©voir (30 jours)</div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush">
          {% for v in alerts.due_soon %}
          <li class="list-group-item">
            <a href="{{ url_for('view_cat', cat_id=v.cat.id) }}">{{ v.cat.name }}</a>
            ‚Äî <strong>{{ v.vaccine }}</strong>
            <div class="small text-muted">
              Dernier: {{ v.last_date.strftime('%d/%m/%Y') }}, rappel: {{ v.next_due.strftime('%d/%m/%Y') }}
            </div>
          </li>
          {% else %}
          <li class="list-group-item">Aucun vaccin imminent.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card">
      <div class="card-header">Calendrier (lecture + clic vers √©dition)</div>
      <div class="card-body">
        <div id="calendar"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  if (!window.FullCalendar) return;
  var el = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(el, {
    timeZone: 'local',
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
    events: "{{ url_for('api_appointments') }}",
    eventDidMount: function(info){
      const p = info.event.extendedProps || {};
      const cats = (p.cats || []).join(', ') || '‚Äî';
      const emps = (p.employees || []).join(', ') || '‚Äî';
      const time = p.time || info.event.start.toLocaleString();
      const notes = p.notes ? `<div class="text-muted small">Notes: ${p.notes}</div>` : '';
      const html = `
        <div><strong>${info.event.title}</strong></div>
        <div>üïí ${time}</div>
        <div>üêæ Chats: ${cats}</div>
        <div>üë• Employ√©s: ${emps}</div>
        ${notes}
      `;
      new bootstrap.Tooltip(info.el, { title: html, html: true, placement: 'top', trigger: 'hover' });
    },
    eventClick: function(info){
      if(info.event.url){
        window.location.href = info.event.url;
        info.jsEvent.preventDefault();
      }
    }
  });
  calendar.render();
});
</script>
{% endblock %}
